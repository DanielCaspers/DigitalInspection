@model DigitalInspection.ViewModels.UploadInspectionPhotosViewModel

@{
	const string TEMPLATE_NAMESPACE = "uploadInspectionPhotosDialog";
	const string CANCEL = TEMPLATE_NAMESPACE + "_cancel";
	const string SUCCESS = TEMPLATE_NAMESPACE + "_success";
}

@if (Model.ChecklistItem != null)
{
	<script>
		var CAPTURE_PHOTO_TEXT = "Take a photo";
		var ACCEPTANCE_PHOTO_TEXT = "Retake or keep going"
		var carouselInsertionIndex = 1;
		Webcam.set({
			width: 480,
			height: 360,
			dest_width: 480,
			dest_height: 360,
			image_format: 'jpeg',
			jpeg_quality: 90,
			//force_flash: false
		});
		Webcam.attach('#camera-viewfinder');

		function setCameraViewfinderCaption(message){
			$("#camera-viewfinder-caption").text(message);
		}

		/*
			mode - "capture" or "acceptance"
		*/
		function setControlVisibilityMode(mode) {
			if (mode === "capture") {
				$(".photo-control.capture-control").addClass("visible");
				$(".photo-control.acceptance-control").removeClass("visible");
			}
			else if (mode === "acceptance") {
				$(".photo-control.acceptance-control").addClass("visible");
				$(".photo-control.capture-control").removeClass("visible");
			}
		}

		function savePhotoToDOM(data_uri) {
			$(".carousel-inner").append(
				'<div class="item">' +
					'<div class="snapshot-display">' +
						'<img src="' + data_uri + '"/>' +
					'</div>' +
					'<div class="carousel-caption">' +
						'<span>Pretty neat, huh?</span>' +
					'</div>' +
				'</div>'
			);
		}

		function freezePhoto() {
			Webcam.freeze();
			setCameraViewfinderCaption(ACCEPTANCE_PHOTO_TEXT);
			setControlVisibilityMode("acceptance");
		}

		function retryPhoto() {
			Webcam.unfreeze();
			setCameraViewfinderCaption(CAPTURE_PHOTO_TEXT);
			setControlVisibilityMode("capture");
		}

		function acceptPhoto() {
			// take snapshot and get image data
			Webcam.snap(function (data_uri) {
				// Push into next carousel index

				// Dynamically add <li>
				$(".carousel-indicators")
					.append("<li data-target='#myCarousel' data-slide-to='" + carouselInsertionIndex + "'></li>");

				// Enable left and right chevron on the first time
				if (carouselInsertionIndex === 1) {
					$(".carousel-control").addClass("visible");
				}
				carouselInsertionIndex++;

				setCameraViewfinderCaption(CAPTURE_PHOTO_TEXT);
				setControlVisibilityMode("capture");
				savePhotoToDOM(data_uri);
			});
		}
	</script>
	<div id="@TEMPLATE_NAMESPACE" class="modal fade">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
					<h4 class="modal-title">Upload photos - @Model.ChecklistItem.Name</h4>
				</div>
				@*@using (Ajax.BeginForm(
						"Create",
						"Tags",
						FormMethod.Post,
						new AjaxOptions
						{
							InsertionMode = InsertionMode.Replace,
							UpdateTargetId = "tagList"
						},
						new { id = "addTagForm", autocomplete = "off" })
					)
					{*@
				<form id="uploadInspectionPhotosForm">
					<div class="modal-body">
						<div id="myCarousel" class="carousel slide" data-ride="carousel" data-interval="false">
							<!-- Indicators -->
							<ol class="carousel-indicators">
								<li data-target="#myCarousel" data-slide-to="0" class="active"></li>
							</ol>

							<!-- Wrapper for slides -->
							<div class="carousel-inner container-flex center">
								<div class="item active">
									<div id="camera-viewfinder"></div>
									<div class="carousel-caption">
										<span id="camera-viewfinder-caption">Take a photo</span>
									</div>
								</div>
							</div>

							<!-- Left and right controls -->
							<a class="left carousel-control" href="#myCarousel" data-slide="prev">
								<span class="glyphicon glyphicon-chevron-left"></span>
								<span class="sr-only">Previous</span>
							</a>
							<a class="right carousel-control" href="#myCarousel" data-slide="next">
								<span class="glyphicon glyphicon-chevron-right material-primary"></span>
								<span class="sr-only">Next</span>
							</a>
						</div>
					</div>

					<div class="container-flex center">
						<div class="photo-control capture-control visible">
							<button class="btn btn-primary"
									type="button"
									onclick="freezePhoto()">
								<i class="material-icons md-36">camera_alt</i>
							</button>
						</div>

						<div class="photo-control acceptance-control">
							<button class="btn btn-primary"
									type="button"
									onclick="retryPhoto()">
								<i class="material-icons md-36">undo</i>
							</button>
							<button class="btn btn-primary"
									type="button"
									onclick="acceptPhoto()">
								<i class="material-icons md-36">check</i>
							</button>
						</div>
					</div>

					<div class="modal-footer">
						<button id="@CANCEL" type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
						<button id="@SUCCESS" type="submit" class="btn btn-primary" data-dismiss="modal" disabled="disabled">Upload</button>
					</div>
				</form>
				@*}*@
			</div>
		</div>
	</div>
}

